# benchmarkå·¥å…·

> ## ğŸš¨ å¼ƒç”¨è¯´æ˜
>
> æœ¬æ–‡æ¡£å·²è¿‡æ—¶ï¼Œä¸å†è¿›è¡Œç»´æŠ¤ï¼Œå¹¶å°†åœ¨ *1.5.0* ç‰ˆæœ¬ä¸‹æ¶ï¼Œå…¶ä¸­å¯èƒ½åŒ…å«è¿‡æ—¶çš„ä¿¡æ¯æˆ–å·²è¢«æ›´æ–°çš„åŠŸèƒ½æ›¿ä»£ã€‚å»ºè®®å‚è€ƒæœ€æ–°çš„ **[å®˜æ–¹æ–‡æ¡£](https://www.mindspore.cn/mindformers/docs/zh-CN/dev/index.html)** ï¼Œä»¥è·å–å‡†ç¡®çš„ä¿¡æ¯ã€‚
>
> å¦‚æœæ‚¨ä»éœ€ä½¿ç”¨æœ¬æ–‡æ¡£ä¸­çš„å†…å®¹ï¼Œè¯·ä»”ç»†æ ¸å¯¹å…¶é€‚ç”¨æ€§ï¼Œå¹¶ç»“åˆæœ€æ–°ç‰ˆæœ¬çš„ç›¸å…³èµ„æºè¿›è¡ŒéªŒè¯ã€‚
>
> å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ **[ç¤¾åŒºIssue](https://gitee.com/mindspore/mindformers/issues/new)** æäº¤åé¦ˆã€‚æ„Ÿè°¢æ‚¨çš„ç†è§£ä¸æ”¯æŒï¼

## æ¦‚è¿°

å¤§æ¨¡å‹è®­ç»ƒbenchmarkï¼Œæ—¨åœ¨æä¾›é«˜æ•ˆçš„å·¥å…·ï¼Œæ”¯æ’‘ç”¨æˆ·å®ç°å¿«æ·éƒ¨ç½²ã€‚
ç”¨æˆ·æä¾›æ¨¡å‹ä»£ç ã€æƒé‡ã€åˆ†è¯æ¨¡å‹ã€é…ç½®æ–‡ä»¶ã€è®­ç»ƒæ•°æ®ç­‰ä¾èµ–çš„ä¿¡æ¯ï¼Œå³å¯å¿«æ·å¯åŠ¨æ¨¡å‹è®­ç»ƒã€å¾®è°ƒä»»åŠ¡ã€‚å½“å‰éƒ¨åˆ†è®­ç»ƒæ•°æ®å·²ç»æ”¯æŒåœ¨çº¿æ¨¡å¼ï¼Œéšç€å¼€æºç¤¾åŒºçš„å»ºè®¾ï¼Œæ¨¡å‹è®­ç»ƒã€å¾®è°ƒæ‰€éœ€çš„å„é¡¹ä¿¡æ¯å°†é€æ­¥æ”¯æŒåœ¨çº¿æ¨¡å¼ã€‚å½“å‰é€‚é…Llama2ã€Llama3.1ã€mixtralç­‰æ¨¡å‹ï¼Œåç»­å°†æŒç»­é€‚é…æ›´å¤šæ¨¡å‹ã€‚

## ä½¿ç”¨ä»‹ç»

ç”¨æˆ·åªéœ€æä¾›å¿…è¦çš„æ•°æ®ã€é…ç½®æ–‡ä»¶ã€æƒé‡ç­‰ä¿¡æ¯ï¼Œæ‰§è¡Œ[pretrain_tool.sh](https://gitee.com/mindspore/mindformers/blob/dev/scripts/benchmark/pretrain_tool.sh)è„šæœ¬å³å¯å¯åŠ¨ç›¸åº”è®­ç»ƒã€å¾®è°ƒä»»åŠ¡ã€‚å…¶ä¸­æ•°æ®æ”¯æŒåŸå§‹æ•°æ®ã€é¢„å¤„ç†ä¹‹åçš„æ•°æ®ï¼Œéƒ¨åˆ†æ•°æ®æ”¯æŒåœ¨çº¿æ¨¡å¼ï¼Œå³åªæä¾›æ•°æ®é›†åç§°å³å¯ã€‚è„šæœ¬å‚æ•°ä»‹ç»å¦‚ä¸‹ï¼š

| å‚æ•°              | ç®€å†™ | å•æœºæ˜¯å¦å¿…é€‰ | å¤šæœºæ˜¯å¦å¿…é€‰ | é»˜è®¤å€¼           | è¯´æ˜                                                         |
| ----------------- | ---- | ------------ | ------------ | ---------------- | ------------------------------------------------------------ |
| model_name_or_dir | n    | âˆš            | âˆš            |                  | æ¨¡å‹è·¯å¾„ï¼ŒåŒ…å«æ¨¡å‹é…ç½®åŠæƒé‡(éå¿…é¡»)                         |
| pretrain_data     | i    | âˆš            | âˆš            |                  | è®­ç»ƒæ•°æ®æ”¯æŒæ•°æ®ç±»å‹ï¼š<br>-åŸå§‹æ•°æ®é›†<br>-é¢„å¤„ç†åçš„æ•°æ®é›†<br>-æ•°æ®é›†åç§°ï¼ˆå½“å‰ä»…æ”¯æŒwikitext2ï¼‰ |
| worker_num        | w    | Ã—            | âˆš            | 8                | æ‰€æœ‰èŠ‚ç‚¹ä¸­ä½¿ç”¨è®¡ç®—å¡çš„æ€»æ•°                                   |
| local_worker      | l    | Ã—            | âˆš            | 8                | å½“å‰èŠ‚ç‚¹ä¸­ä½¿ç”¨è®¡ç®—å¡çš„æ•°é‡                                   |
| master_addr       | a    | Ã—            | âˆš            | 127.0.0.1        | æŒ‡å®šåˆ†å¸ƒå¼å¯åŠ¨ä¸»èŠ‚ç‚¹çš„ip                                     |
| master_port       | p    | Ã—            | âˆš            | 8118             | æŒ‡å®šåˆ†å¸ƒå¼å¯åŠ¨ç»‘å®šçš„ç«¯å£å·                                   |
| node_rank         | r    | Ã—            | âˆš            | 0                | æŒ‡å®šå½“å‰èŠ‚ç‚¹çš„rank id                                        |
| log_dir           | g    | Ã—            | âˆš            | output/msrun_log | æ—¥å¿—è¾“å‡ºè·¯å¾„ï¼Œè‹¥ä¸å­˜åœ¨åˆ™é€’å½’åˆ›å»º                             |
| join              | j    | Ã—            | âˆš            | FALSE            | æ˜¯å¦ç­‰å¾…æ‰€æœ‰åˆ†å¸ƒå¼è¿›ç¨‹é€€å‡º                                   |
| cluster_time_out  | t    | Ã—            | âˆš            | 7200             | åˆ†å¸ƒå¼å¯åŠ¨çš„ç­‰å¾…æ—¶é—´ï¼Œå•ä½ä¸ºç§’                               |

## ä½¿ç”¨ç¤ºä¾‹

### ä½¿ç”¨åœ¨çº¿æ•°æ®æ‰§è¡Œè®­ç»ƒ

ä»¥Llama2-7Bä¸ºä¾‹ï¼Œå°†æ¨¡å‹è®­ç»ƒæ‰€éœ€çš„é…ç½®æ–‡ä»¶åŠå¯¹åº”çš„`tokenizer.model`æ”¾å…¥`${model_pah}`ç›®å½•ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š

```shell
cd scripts/benchmark

bash pretrain_tool.sh -n ${model_pah} -i wikitext2
```

### ä½¿ç”¨åŸå§‹ç¦»çº¿æ•°æ®æ‰§è¡Œè®­ç»ƒ

ä»¥Llama2-7Bä¸ºä¾‹ï¼Œå°†æ¨¡å‹è®­ç»ƒæ‰€éœ€çš„é…ç½®æ–‡ä»¶åŠå¯¹åº”çš„`tokenizer.model`æ”¾å…¥`${model_pah}`ç›®å½•ï¼Œå°†è®­ç»ƒæ•°æ®`wiki.train.tokens`æ”¾å…¥`${data_pah}`ç›®å½•ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š

```shell
cd scripts/benchmark

bash pretrain_tool.sh -n ${model_pah} -i ${data_pah}/wiki.train.tokens
```

### ä½¿ç”¨é¢„å¤„ç†ç¦»çº¿æ•°æ®æ‰§è¡Œå¾®è°ƒ

ä»¥Llama3.1-8Bä¸ºä¾‹ï¼Œå°†æ¨¡å‹è®­ç»ƒæ‰€éœ€çš„é…ç½®æ–‡ä»¶å’Œæƒé‡`ckpt`æ–‡ä»¶æ”¾å…¥`${model_pah}`ï¼Œå°†è®­ç»ƒæ•°æ®`alpaca-fastchat8192.mindrecord`æ”¾å…¥`${data_pah}`ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š

```shell
cd scripts/benchmark

bash pretrain_tool.sh -n ${model_pah} -i ${data_pah}/alpaca-fastchat8192.mindrecord
```

### ä½¿ç”¨é¢„å¤„ç†ç¦»çº¿æ•°æ®æ‰§è¡Œå¤šæœºè®­ç»ƒ

ä»¥Mixtralä¸ºä¾‹ï¼Œåœ¨ä¸¤å°æœºå™¨ä¸Šï¼Œå°†æ¨¡å‹è®­ç»ƒæ‰€éœ€çš„é…ç½®æ–‡ä»¶å’Œæƒé‡`ckpt`æ–‡ä»¶æ”¾å…¥`${model_pah}`ç›®å½•ï¼Œå°†è®­ç»ƒæ•°æ®`alpaca-fastchat8192.mindrecord`æ”¾å…¥`${data_pah}`ç›®å½•ï¼Œç„¶ååˆ†åˆ«æ‰§è¡Œä¸‹è¿°å‘½ä»¤ã€‚

* æœºå™¨0

  ```shell
  cd scripts/benchmark

  bash pretrain_tool.sh -n ${model_pah} -i ${data_pah}/wiki.train.tokens -w 16 -l 8 -a ${master_addr} -p 8118 -r 0 -o output/msrun_log -j False -t 300
  ```

* æœºå™¨1

  ```shell
  cd scripts/benchmark

  bash pretrain_tool.sh -n ${model_pah} -i ${data_pah}/wiki.train.tokens -w 16 -l 8 -a ${master_addr} -p 8118 -r 1 -o output/msrun_log -j False -t 300
  ```

ä¸¤å°æœºå™¨çš„å‘½ä»¤ä¸»è¦æ˜¯node_rankï¼ˆå³ -rï¼‰å‚æ•°ä¸åŒã€‚
